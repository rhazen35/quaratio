<?php

namespace web\tmp\xmlModel\xmlModelReport;

use \application\controller;

/**
 * Get the last inserted model id
 * The model id is passed to the preview
 */
$data    = unserialize( CMS_GET_DATA );
$allowed = ['xmlModelId'];

if( !empty( $data ) ):
    foreach( $data as $key => $value ):
        if( in_array( $key, $allowed ) ) ${$key} = $value;
    endforeach;
endif;

$xmlModelId = ( !empty( $xmlModelId ) ? $xmlModelId : "" );

/**
 * Handle error controls when posting
 */
if( $_SERVER['REQUEST_METHOD'] === "POST" ):
    ( new controller\Controller( "handler", "xmlModelErrorControl", "xmlModel" ) )->request();
    exit();
endif;

/**
 * Get the report session and unserialize it
 */
$report = unserialize( $_SESSION['xmlValidatorReport'] );

/**
 * Check if the report has a file exists flag, if so validation failed.
 */
if( isset( $report['file_exists'] ) && $report['file_exists'] === true ):
    $fileExists = true;
    $validationMessage = "Model exists";
endif;

/**
 * Set up data array's for back to upload and PRG-pattern
 */
$urlDataUpload  = array( "requestType" => "template", "requestAttribute" => "home", "requestDirectory" => "common" );
$urlDataPRG     = array( "requestType" => "template", "requestAttribute" => "xmlModelReport", "requestDirectory" => "xmlModel" );
$urlDataPreview = array( "requestType" => "template", "requestAttribute" => "preview", "requestDirectory" => "xmlModel", "xmlModelId" => $xmlModelId );
$urlDataUpload  = base64_encode( json_encode( $urlDataUpload ) );
$urlDataPRG     = base64_encode( json_encode( $urlDataPRG ) );
$urlDataPreview = base64_encode( json_encode( $urlDataPreview ) );

?>

<div class="modelReport">

    <div class="modelReport-goBack">
        <a href="<?= LITENING_SELF.'?data='.$urlDataUpload; ?>">terug naar uploaden</a>
        <br><br><br>
        <a href="<?= LITENING_SELF.'?data='.$urlDataPreview; ?>">Bekijk de preview</a>
    </div>

    <div class="modelReport-Title">XML Report - Enterprise Architect Model</div>

        <div class="modelReport-container">

                <div class="modelReport-totalValidation <?= ( $report['validation']['valid'] === true && isset( $fileExists) !== true ? "totalValidationGreen" : "totalValidationRed" ) ?>">
                    <?= ( isset( $fileExists ) && $fileExists === true ? $validationMessage : $report['validation']['message'] ); ?>
                </div>

                <div class="modelReport-totalErrorTypes">

                    <div class="modelReport-totalErrorType-valid">
                        <form action="<?= LITENING_SELF.'?data='.$urlDataPRG; ?>" method="POST">
                            <img src="./images/icons/checkgreen_icon.png"> Valid ( <strong><?= $report['totalErrorTypes']['valid']; ?></strong> )
                            <?php if( isset( $_SESSION['xmlModelErrorValid'] ) && $_SESSION['xmlModelErrorValid'] === "hide" ): ?>
                                <input type="hidden" name="type" value="valid">
                                <input type="hidden" name="display" value="show">
                                <input type="submit" name="submitTypeVisibility" value="show">
                            <?php else: ?>
                                <input type="hidden" name="type" value="valid">
                                <input type="hidden" name="display" value="hide">
                                <input type="submit" name="submitTypeVisibility" value="hide">
                            <?php endif; ?>
                        </form>
                    </div>

                    <div class="modelReport-totalErrorType">
                        <form action="<?= LITENING_SELF.'?data='.$urlDataPRG; ?>" method="POST">
                            <img src="./images/icons/severe_icon.png"> Severe ( <strong><?= $report['totalErrorTypes']['severe']; ?></strong> )
                            <?php if( isset( $_SESSION['xmlModelErrorSevere'] ) && $_SESSION['xmlModelErrorSevere'] === "hide" ): ?>
                                    <input type="hidden" name="type" value="severe">
                                    <input type="hidden" name="display" value="show">
                                    <input type="submit" name="submitTypeVisibility" value="show">
                            <?php else: ?>
                                    <input type="hidden" name="type" value="severe">
                                    <input type="hidden" name="display" value="hide">
                                    <input type="submit" name="submitTypeVisibility" value="hide">
                            <?php endif; ?>
                        </form>
                    </div>

                    <div class="modelReport-totalErrorType">
                        <div class="modelReport-totalErrorType-box">
                            <form action="<?= LITENING_SELF.'?data='.$urlDataPRG; ?>" method="POST">
                                <img src="./images/icons/red_cross_icon.png">Errors ( <strong><?= $report['totalErrorTypes']['error']; ?></strong> )
                                <?php if( isset( $_SESSION['xmlModelErrorError'] ) && $_SESSION['xmlModelErrorError'] === "hide" ): ?>
                                    <input type="hidden" name="type" value="error">
                                    <input type="hidden" name="display" value="show">
                                    <input type="submit" name="submitTypeVisibility" value="show">
                                <?php else: ?>
                                    <input type="hidden" name="type" value="error">
                                    <input type="hidden" name="display" value="hide">
                                    <input type="submit" name="submitTypeVisibility" value="hide">
                                <?php endif; ?>
                            </form>
                        </div>
                    </div>

                    <div class="modelReport-totalErrorType modelReportWarningError">
                        <form action="<?= LITENING_SELF.'?data='.$urlDataPRG; ?>" method="POST">
                            <img src="./images/icons/warning_icon.png"> Warnings ( <strong><?= $report['totalErrorTypes']['warning']; ?></strong> )
                            <?php if( isset( $_SESSION['xmlModelErrorWarning'] ) && $_SESSION['xmlModelErrorWarning'] === "hide" ): ?>
                                <input type="hidden" name="type" value="warning">
                                <input type="hidden" name="display" value="show">
                                <input type="submit" name="submitTypeVisibility" value="show">
                            <?php else: ?>
                                <input type="hidden" name="type" value="warning">
                                <input type="hidden" name="display" value="hide">
                                <input type="submit" name="submitTypeVisibility" value="hide">
                            <?php endif; ?>
                        </form>
                    </div>

                    <div class="modelReport-totalErrorType modelReportInfoError">
                        <form action="<?= LITENING_SELF.'?data='.$urlDataPRG; ?>" method="POST">
                            <img src="./images/icons/info_icon_blue.png"> Info ( <strong><?= $report['totalErrorTypes']['info']; ?></strong> )
                            <?php if( isset( $_SESSION['xmlModelErrorInfo'] ) && $_SESSION['xmlModelErrorInfo'] === "hide" ): ?>
                                <input type="hidden" name="type" value="info">
                                <input type="hidden" name="display" value="show">
                                <input type="submit" name="submitTypeVisibility" value="show">
                            <?php else: ?>
                                <input type="hidden" name="type" value="info">
                                <input type="hidden" name="display" value="hide">
                                <input type="submit" name="submitTypeVisibility" value="hide">
                            <?php endif; ?>
                        </form>
                    </div>

                </div>

            <div class="modelReport-item modelReport-grayBack">
                <div class="modelReport-item-img">
                    <div class="modelReport-item-type">Type</div>
                </div>
                <div class="modelReport-item-name">Subject</div>
                <div class="modelReport-item-value">Information</div>
                <div class="modelReport-item-message">Description</div>
            </div>

            <?php

            /**
             * Show all report items, excluding the validation array.
             */
                if( !empty( $report ) ):

                    echo '<div class="modelReport-Header">Model and extension</div>';

                    foreach( $report as $key => $v ):

                        if( !empty( $report[$key]['type'] ) && $key !== "validation" ):

                            $sessionType = ( isset( $_SESSION['xmlModelError'.( ucfirst( $report[$key]['type'] ) )] ) ? $_SESSION['xmlModelError'.( ucfirst( $report[$key]['type'] ) )] : "");
                            if( !empty( $sessionType && $sessionType === "hide" ) ):

                            else:

                                ?>

                                <div class="modelReport-item">
                                    <?php $type = $report[$key]['type']; ?>
                                    <div class="modelReport-item-img">
                                        <img src="./images/icons/<?= ( $type === "warning" ? "warning_icon.png" : ( $type === "info" ? "info_icon_blue.png" : ( $type === "severe" ? "severe_icon.png" : ( $type === "error" ? "red_cross_icon.png" : "checkgreen_icon.png") ) ) ); ?>">
                                        <div class="modelReport-item-type"> <?= $report[$key]['type']; ?></div>
                                    </div>
                                    <div class="modelReport-item-name"><?= $report[$key]['name']; ?></div>
                                    <div class="modelReport-item-value"><?= $report[$key]['value']; ?></div>
                                    <div class="modelReport-item-message"><?= $report[$key]['message']; ?></div>
                                </div>

                                <?php if( $report[$key]['valid'] === false ): ?>
                                    <div class="modelReport-item">
                                        <div class="modelReport-item-img"></div>
                                        <div class="modelReport-item-info">
                                            <img src="./images/icons/arrow_right_up.png">
                                            <div class="<?= ( $type === "warning" ? "modelReport-warning" : ( $type === "info" ? "modelReport-info" : ( $type === "severe" ? "modelReport-severe" : ( $type === "error" ? "modelReport-error" : "" ) ) ) ) ?>">
                                                <?= $report[$key]['info']; ?>
                                            </div>
                                        </div>
                                    </div>
                                    <?php

                                endif;

                            endif;

                        endif;

                    endforeach;

                endif;
                /**
                 * Fields errors.
                 * Initial value, data type, attribute documentation.
                 */
                if( !empty( $report['initialValueType'] ) ):

                    echo '<div class="modelReport-Header">Attributes</div>';

                    foreach( $report['initialValueType'] as $initialValueType => $value ):

                        $totalInitialValueTypes = count( $report['initialValueType'][$initialValueType] );

                        for( $i = 0; $i < $totalInitialValueTypes; $i++ ):

                            if( isset( $report['initialValueType'][$initialValueType]['type'.($i+1)] ) ):

                                $sessionType = ( isset( $_SESSION['xmlModelError'.( ucfirst( $report['initialValueType'][$initialValueType]['type'.($i+1)]['type'] ) )] ) ? $_SESSION['xmlModelError'.( ucfirst( $report['initialValueType'][$initialValueType]['type'.($i+1)]['type'] ) )] : "");

                                if( !empty( $sessionType && $sessionType === "hide" ) ):

                                else:

                                    ?>
                                        <div class="modelReport-item">
                                            <?php $type = $report['initialValueType'][$initialValueType]['type'.($i+1)]['type']; ?>
                                            <div class="modelReport-item-img">
                                                <img src="./images/icons/<?= ( $type === "warning" ? "warning_icon.png" : ( $type === "info" ? "info_icon_blue.png" : ( $type === "severe" ? "severe_icon.png" : ( $type === "error" ? "red_cross_icon.png" : "checkgreen_icon.png") ) ) ); ?>">
                                                <div class="modelReport-item-type"> <?= $report['initialValueType'][$initialValueType]['type'.($i+1)]['type']; ?></div>
                                            </div>
                                            <div class="modelReport-item-name"><?= $report['initialValueType'][$initialValueType]['type'.($i+1)]['name']; ?></div>
                                            <div class="modelReport-item-value"><?= $report['initialValueType'][$initialValueType]['type'.($i+1)]['value']; ?></div>
                                            <div class="modelReport-item-message"><?= $report['initialValueType'][$initialValueType]['type'.($i+1)]['message']; ?></div>
                                        </div>

                                        <?php if( $report['initialValueType'][$initialValueType]['type'.($i+1)]['valid'] === false ): ?>
                                            <div class="modelReport-item">
                                                <div class="modelReport-item-img"></div>
                                                <div class="modelReport-item-info">
                                                    <img src="./images/icons/arrow_right_up.png">
                                                    <div class="<?= ( $type === "warning" ? "modelReport-warning" : ( $type === "info" ? "modelReport-info" : ( $type === "severe" ? "modelReport-severe" : ( $type === "error" ? "modelReport-error" : "" ) ) ) ) ?>">
                                                        <?= $report['initialValueType'][$initialValueType]['type'.($i+1)]['info']; ?>
                                                    </div>
                                                </div>
                                            </div>
                                        <?php endif; ?>

                                    <?php

                                endif;

                            endif;

                        endfor;

                    endforeach;

                endif;


                /**
                 * Operation errors.
                 * Documentation, tags, file, tab, cell, order.
                 */
                if( !empty( $report['operations'] ) ):

                    echo '<div class="modelReport-Header">Operations</div>';

                    foreach( $report['operations'] as $operation => $value ):

                        $totalOperations = count( $report['operations'][$operation] );

                        for( $i = 0; $i < $totalOperations; $i++ ):

                            $sessionType = ( isset( $_SESSION['xmlModelError'.( ucfirst( $report['operations'][$operation]['operation'.($i+1)]['type'] ) )] ) ? $_SESSION['xmlModelError'.( ucfirst( $report['operations'][$operation]['operation'.($i+1)]['type'] ) )] : "");

                            if( !empty( $sessionType && $sessionType === "hide" ) ):

                            else:

                                ?>
                                    <div class="modelReport-item">
                                        <?php $type = $report['operations'][$operation]['operation'.($i+1)]['type']; ?>
                                        <div class="modelReport-item-img">
                                            <img src="./images/icons/<?= ( $type === "warning" ? "warning_icon.png" : ( $type === "info" ? "info_icon_blue.png" : ( $type === "severe" ? "severe_icon.png" : ( $type === "error" ? "red_cross_icon.png" : "checkgreen_icon.png") ) ) ); ?>">
                                            <div class="modelReport-item-type"> <?= $report['operations'][$operation]['operation'.($i+1)]['type']; ?></div>
                                        </div>
                                        <div class="modelReport-item-name"><?= $report['operations'][$operation]['operation'.($i+1)]['name']; ?></div>
                                        <div class="modelReport-item-value"><?= $report['operations'][$operation]['operation'.($i+1)]['value']; ?></div>
                                        <div class="modelReport-item-message"><?= $report['operations'][$operation]['operation'.($i+1)]['message']; ?></div>
                                    </div>

                                    <?php if( $report['operations'][$operation]['operation'.($i+1)]['valid'] === false ): ?>
                                        <div class="modelReport-item">
                                            <div class="modelReport-item-img"></div>
                                            <div class="modelReport-item-info">
                                                <img src="./images/icons/arrow_right_up.png">
                                                <div class="<?= ( $type === "warning" ? "modelReport-warning" : ( $type === "info" ? "modelReport-info" : ( $type === "severe" ? "modelReport-severe" : ( $type === "error" ? "modelReport-error" : "" ) ) ) ) ?>">
                                                    <?= $report['operations'][$operation]['operation'.($i+1)]['info']; ?>
                                                </div>
                                            </div>
                                        </div>
                                    <?php

                                endif;

                            endif;

                        endfor;

                    endforeach;

                endif;

            ?>

        </div>

</div>

